#!/usr/bin/env bash

set -e

DEPLOYMENT_NAME="messaging-app-blue"
SERVICE_NAME="messaging-app-service"
PORT=8000

echo "Applying updated deployment (image version 2.0)..."
kubectl apply -f blue_deployment.yaml

echo "Monitoring rolling update progress..."
kubectl rollout status deployment $DEPLOYMENT_NAME

echo "Starting port-forward for downtime test..."
kubectl port-forward service/$SERVICE_NAME $PORT:$PORT &
PORT_FORWARD_PID=$!

sleep 5

echo "Testing app availability with curl..."
for i in {1..15}
do
  curl -s http://127.0.0.1:$PORT > /dev/null && echo "Request $i: OK"
  sleep 1
done

echo "Stopping port-forward..."
kill $PORT_FORWARD_PID

echo "Verifying running pods..."
kubectl get pods

echo "Rolling update completed successfully"